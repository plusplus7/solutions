---
layout: post
title: 【Weekly Report】2020.04.19 ~ 2020.04.25
date: 2020-04-19 07:07
tags:
    - Weekly
---

# 全年一共52个日历周，本周是第18周

Your 2020 usage:34.6%

```
[##################                                                  ]
```

# 防护升级！兼职安全工程师如何假装很熟练地给网站做安全检查

从14年起，我便开始维护我的个人主页plusplus7.com。因为本来就是业余时间维护，所以没有弄得太复杂。总体来说，就是一个Python + Redis + MySQL的小网站，还不支持HTTPS。

被PL爷吐槽“我去上个厕所的功夫就能给你黑掉”，于是我便做了少些安全加固，最重要的一点就是加上了HTTPS。

当然，用了HTTPS也并不代表网站就是安全的。特别是对于用户来说，HTTPS可以保证通信线路安全，但是无法防止服务端的主观恶意。

HTTPS的配置也并不简单。那么有没有什么工具可以简单快速地对网站做安全检查呢？

### Qualys SSL Labs

Qualys公司提供的SSL Labs是一套针对SSL扫描分析的文档和工具。其中便提供了对服务器进行扫描分析的[SSL Server Test](https://www.ssllabs.com/ssltest/index.html)。

![QualysMain](https://raw.githubusercontent.com/plusplus7/solutions/master/weekly/2020/miscs/week15/QualysSslMain.png)


SSL Server Test的扫描大致包含四个步骤：

1. 查看证书是否合法
2. 扫描服务器的SSL配置，比如协议，密钥交换算法，加密算法等
3. 根据扫描结果得出分数，从0到100
4. 最后再根据分数和一套特殊规则，来给出最后的评级，从A到F。

有的规则可能会导致评级下降，而有的规则会提升评级。当然，还有一些特殊的情况，也会给出M级：证书名不匹配和T级：证书不被信任。

大概过1分钟左右，检查完成。

最终，我的网站拿到了B级的评价！

![Qualys_plusplus7com](https://raw.githubusercontent.com/plusplus7/solutions/master/weekly/2020/miscs/week15/Qualys_plusplus7com.png)

扫描报告分为几个部分，每一部分包含若干子项目。存在安全风险的项目会被标记为橙色。

### Part 1 证书

![Qualys_plusplus7com](https://raw.githubusercontent.com/plusplus7/solutions/master/weekly/2020/miscs/week15/Qualys_Part1Certificate.png)

第一部分是证书。

Subject, Common name, Alternative names, Serial Number...这些都是普通的证书应该有的属性。

#### Key

这一栏的信息表明，生成这份证书的Key是2048位的RSA密钥，其中E=65537。

#### Weak Key(Debian)

Linux系统的Debian发行版在2006发布的OpenSSL包中包含一个bug。这个bug使得Debian以及其衍生系统会生成较弱的密钥。这个bug直到2008年才被修复。

这项检测便是针对这个bug来检查证书中是否使用了此类较弱的密钥。

#### Issuer

我的这份证书是由Let's Encryt颁发的，所以Issuer这一栏是Let's Encryt证书机构的信息。

#### Signature algorithm

这里的SHA256WithRSA，是指浏览器需通过SHA256算法计算证书摘要+RSA私钥签名来验证证书链。

#### Extended Validation

这里的Extended Validation，缩写为EV，是指SSL证书的验证级别。目前的级别分为DV，OV，EV三种。

* DV, Domain validated. 获得该类型证书只需要通过域名所有者邮箱验证，或者在域名下，添加一个外部可访问的路径，内容为CA提供的验证文件。

* OV, Organization validated. 获得该类型证书，需要在DV证书的基础上，并且需要请求者属于某一个组织，如，银行，企业，政府单位。不同CA有不同的方式去验证该组织的合法性。

* EV, Extended validation.  获得该类型证书，需要在OV证书的基础上，验证方式更加严格，包括但不限于人工审核。

我在Let's Encryt上申请的证书属于最容易获得的DV证书，所以这里的扫描结果是No。

#### Certificate Transparency

Certificate Transparency，缩写为CT，是一项用于监控审计证书签发的通用标准。所有的CA签发证书时，必须写一条记录到公开透明的CT日志服务器中。任何人以及浏览器都可以去访问日志服务器来验证该证书是否在CT日志服务器中存在。

当证书被成功提交到CT服务器，CT服务器会返回一个Signed certificate timestamp，缩写为SCT。浏览器便可以根据SCT去日志服务器检查证书是否存在。

当服务器不提供SCT，这里的扫描结果会显示为No。如果是Yes的话，这里的结果也有可能是以下有三种。

* Yes(certificate)
* Yes(TLS extension)
* Yes(stapled OCSP response)

我的情况属于第一种，SCT附带在证书中。第二种情况，是说明SCT是服务器在TLS握手中附带在Server Hello信息中。最后一种情况是说SCT是附带在OCSP Stapling信息中。见下面的OCSP部分。

参考[How Is Certificate Check](https://discussions.qualys.com/thread/16972-how-is-certificate-checked-for-certificate-transparency)

#### OCSP Must Staple

Online Certificate Status Protocol，缩写为OCSP，是一个用于获取证书吊销状态的通用协议。浏览器可以使用OCSP来验证HTTPS证书是否被吊销。

OCSP相较于更原始的CRL，更精简更易实现。OCSP的问题也显而易见。

对于一个HTTPS证书，将会有若干的浏览器去验证其合法性，这势必会让OCSP服务器需要同时响应大量请求。所以便有了OCSP Stapling技术。

OCSP Stapling让服务器主动去OCSP服务器获取一个带签名的OCSP证书状态，并在TLS握手时将其发送给浏览器。浏览器拿到之后便可以在本地直接校验签名和证书状态是否合法，无需再去OCSP服务器请求验证证书。这项技术同时提升了安全和性能。

OCSP Must-Staple是一个证书中的扩展属性，用于告诉浏览器必须通过OCSP检查证书状态，否则就中断访问。

正确配置OCSP Must-Staple并不简单，其需要1. CA颁发证书时添加该扩展属性；2. 服务端提供OCSP Stapling；3. 浏览器正确实现OCSP Must-Staple，否则这个配置将毫无意义。

#### Revocation information

证书吊销信息。这里显示扫描器通过Let's Encryt提供的OCSP检查到了我的证书状态。这里也有可能会显示CRL。

#### Revocation status

证书状态。这里显示我的证书并没有被吊销。

#### DNS CAA

DNS Certification Authority Authorization，简写为DNS CAA，可以让域名持有者通过在DNS服务器中添加一条CAA记录来指定该域名的证书只允许由某特定的CA机构颁发。

我的域名没有添加这类记录，所以扫描结果为No。

#### Trusted

证书是否被信任。

总的来说，我的域名和证书虽然还有一些可以提升的空间，但是已经符合可以安全访问的标准，所以被常见的设备和浏览器信任。

这里列出了Mozilla，Apple，Android，Java和Windows，均为绿色，表示证书被信任。

#### Additional and Others

之后的部分还包括证书链，以及CA的Root证书信息。


### TLS/SSL配置

#### Protocols 协议

这里列出了常见的TLS握手协议。TLS 1.2之前的所有协议均被视为存在安全漏洞。

